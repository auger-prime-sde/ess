// UUB Jitter cleaner SI5347 initialization on I2C-1 and dump
// Petr Tobiska, 2020-10-16
// based on jitter_cleaner.c by Roberto Assiro
// compilation:
//   source <path to Xilinx SDK>/settings64.sh
//   make


#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <linux/i2c-dev.h>
#include <sys/ioctl.h>

#undef TESTDUMP   // #define if you want to  dump content of registers
#define IIC_SLAVE_SI5347         0x6C  // The slave address Cleaner Jitter
const char I2C_DEVICE_NAME[] = "/dev/i2c-1";

/*
# Start configuration preamble
0x0B24,0xC0
0x0B25,0x00
# Rev D stuck divider fix
0x0B4E,0x1A
# End configuration preamble
#
# Delay 300 msec
#    Delay is worst case time for device to complete any calibration
#    that is running due to device state change previous to this script
#    being processed.
#
# Start configuration registers
0x0006,0x00
0x0007,0x00
0x0008,0x00
*/

char setHardReset[]={0xFE,0x01,0x00,0x1E,0x02};

char bufEric[] = {
  0x0B, 0x24, 0xC0,
  0x0B, 0x25, 0x02,
  0x0B, 0x4E, 0x1A};

char bufHardReset[] = {
  0x00, 0x1E, 0x02 };

char buf[]={
//	0x0B,0x24,0xD8,0x0B,0x25,0x00,                                              // bank 0xB
    0x00,0x0B,0x6C,0x00,0x16,0x0F,0x00,0x17,0x3C,0x00,0x18,0xFF,0x00,0x19,0xFF, // bank 0
    0x00,0x1A,0xFF,0x00,0x20,0x00,0x00,0x2B,0x0A,0x00,0x2C,0x01,0x00,0x2D,0x01,
    0x00,0x2E,0xE4,0x00,0x2F,0x00,0x00,0x30,0x00,0x00,0x31,0x00,0x00,0x32,0x00,
    0x00,0x33,0x00,0x00,0x34,0x00,0x00,0x35,0x00,0x00,0x36,0xE4,0x00,0x37,0x00,
    0x00,0x38,0x00,0x00,0x39,0x00,0x00,0x3A,0x00,0x00,0x3B,0x00,0x00,0x3C,0x00,
    0x00,0x3D,0x00,0x00,0x3F,0x11,0x00,0x40,0x04,0x00,0x41,0x0D,0x00,0x42,0x00,
    0x00,0x43,0x00,0x00,0x44,0x00,0x00,0x45,0x0C,0x00,0x46,0x32,0x00,0x47,0x00,
    0x00,0x48,0x00,0x00,0x49,0x00,0x00,0x4A,0x32,0x00,0x4B,0x00,0x00,0x4C,0x00,
    0x00,0x4D,0x00,0x00,0x4E,0x05,0x00,0x4F,0x00,0x00,0x51,0x03,0x00,0x52,0x00,
    0x00,0x53,0x00,0x00,0x54,0x00,0x00,0x55,0x03,0x00,0x56,0x00,0x00,0x57,0x00,
    0x00,0x58,0x00,0x00,0x59,0x03,0x00,0x5A,0x00,0x00,0x5B,0x00,0x00,0x5C,0x40,
    0x00,0x5D,0x01,0x00,0x5E,0x00,0x00,0x5F,0x00,0x00,0x60,0x00,0x00,0x61,0x00,
    0x00,0x62,0x00,0x00,0x63,0x00,0x00,0x64,0x00,0x00,0x65,0x00,0x00,0x66,0x00,
    0x00,0x67,0x00,0x00,0x68,0x00,0x00,0x69,0x00,0x00,0x92,0x00,0x00,0x93,0x00,
    0x00,0x94,0x00,0x00,0x95,0x00,0x00,0x96,0x00,0x00,0x97,0x00,0x00,0x98,0x00,
    0x00,0x99,0x00,0x00,0x9A,0x01,0x00,0x9B,0x03,0x00,0x9C,0x00,0x00,0x9D,0x00,
    0x00,0x9E,0x02,0x00,0x9F,0x00,0x00,0xA0,0x00,0x00,0xA1,0x00,0x00,0xA2,0x01,
    0x00,0xA3,0xB8,0x00,0xA4,0x32,0x00,0xA5,0x01,0x00,0xA6,0x00,0x00,0xA7,0x00,
    0x00,0xA8,0x00,0x00,0xA9,0x00,0x00,0xAA,0x00,0x00,0xAB,0x00,0x00,0xAC,0x00,
    0x00,0xAD,0x00,0x00,0xAE,0x00,0x00,0xAF,0x00,0x00,0xB0,0x00,0x00,0xB1,0x00,
    0x00,0xB2,0x00,0x00,0xB3,0x00,0x00,0xB4,0x00,0x00,0xB5,0x00,0x00,0xB6,0x00,
    0x01,0x02,0x01,0x01,0x08,0x02,0x01,0x09,0x09,0x01,0x0A,0x3D,0x01,0x0B,0x00, // bank 1
    0x01,0x0C,0x01,0x01,0x12,0x02,0x01,0x13,0x09,0x01,0x14,0x3D,0x01,0x15,0x00,
    0x01,0x16,0x01,0x01,0x17,0x02,0x01,0x18,0x09,0x01,0x19,0x3D,0x01,0x1A,0x00,
    0x01,0x1B,0x01,0x01,0x1C,0x02,0x01,0x1D,0x09,0x01,0x1E,0x3D,0x01,0x1F,0x00,
    0x01,0x20,0x01,0x01,0x26,0x02,0x01,0x27,0x09,0x01,0x28,0x3D,0x01,0x29,0x00,
    0x01,0x2A,0x01,0x01,0x2B,0x02,0x01,0x2C,0x09,0x01,0x2D,0x3D,0x01,0x2E,0x00,
    0x01,0x2F,0x01,0x01,0x30,0x01,0x01,0x31,0x09,0x01,0x32,0x3B,0x01,0x33,0x00,
    0x01,0x34,0x00,0x01,0x3A,0x01,0x01,0x3B,0x09,0x01,0x3C,0x3B,0x01,0x3D,0x00,
    0x01,0x3E,0x00,0x01,0x3F,0x00,0x01,0x40,0x00,0x01,0x41,0x40,0x01,0x42,0xFF,
    0x02,0x02,0x00,0x02,0x03,0x00,0x02,0x04,0x00,0x02,0x05,0x00,0x02,0x06,0x00, // bank 2
    0x02,0x08,0x3C,0x02,0x09,0x00,0x02,0x0A,0x00,0x02,0x0B,0x00,0x02,0x0C,0x00,
    0x02,0x0D,0x00,0x02,0x0E,0x01,0x02,0x0F,0x00,0x02,0x10,0x00,0x02,0x11,0x00,
    0x02,0x12,0x00,0x02,0x13,0x00,0x02,0x14,0x00,0x02,0x15,0x00,0x02,0x16,0x00,
    0x02,0x17,0x00,0x02,0x18,0x00,0x02,0x19,0x00,0x02,0x1A,0x00,0x02,0x1B,0x00,
    0x02,0x1C,0x00,0x02,0x1D,0x00,0x02,0x1E,0x00,0x02,0x1F,0x00,0x02,0x20,0x00,
    0x02,0x21,0x00,0x02,0x22,0x00,0x02,0x23,0x00,0x02,0x24,0x00,0x02,0x25,0x00,
    0x02,0x26,0x00,0x02,0x27,0x00,0x02,0x28,0x00,0x02,0x29,0x00,0x02,0x2A,0x00,
    0x02,0x2B,0x00,0x02,0x2C,0x00,0x02,0x2D,0x00,0x02,0x2E,0x00,0x02,0x2F,0x00,
    0x02,0x31,0x01,0x02,0x32,0x01,0x02,0x33,0x01,0x02,0x34,0x01,0x02,0x35,0x00,
    0x02,0x36,0x00,0x02,0x37,0x00,0x02,0x38,0x00,0x02,0x39,0x94,0x02,0x3A,0x00,
    0x02,0x3B,0x00,0x02,0x3C,0x00,0x02,0x3D,0x00,0x02,0x3E,0x80,0x02,0x40,0x00,
    0x02,0x41,0x00,0x02,0x42,0x00,0x02,0x43,0x00,0x02,0x44,0x00,0x02,0x45,0x00,
    0x02,0x46,0x00,0x02,0x4A,0x02,0x02,0x4B,0x00,0x02,0x4C,0x00,0x02,0x50,0x02,
    0x02,0x51,0x00,0x02,0x52,0x00,0x02,0x53,0x02,0x02,0x54,0x00,0x02,0x55,0x00,
    0x02,0x56,0x02,0x02,0x57,0x00,0x02,0x58,0x00,0x02,0x5C,0x02,0x02,0x5D,0x00,
    0x02,0x5E,0x00,0x02,0x5F,0x02,0x02,0x60,0x00,0x02,0x61,0x00,0x02,0x62,0x00,
    0x02,0x63,0x00,0x02,0x64,0x00,0x02,0x68,0x00,0x02,0x69,0x00,0x02,0x6A,0x00,
    0x02,0x6B,0x30,0x02,0x6C,0x00,0x02,0x6D,0x00,0x02,0x6E,0x00,0x02,0x6F,0x00,
    0x02,0x70,0x00,0x02,0x71,0x00,0x02,0x72,0x00,
    0x03,0x02,0x00,0x03,0x03,0x00,0x03,0x04,0x00,0x03,0x05,0x80,0x03,0x06,0x12, // bank 3
    0x03,0x07,0x00,0x03,0x08,0x00,0x03,0x09,0x00,0x03,0x0A,0x00,0x03,0x0B,0xF0,
    0x03,0x0D,0x00,0x03,0x0E,0x00,0x03,0x0F,0x00,0x03,0x10,0x80,0x03,0x11,0x00,
    0x03,0x12,0x00,0x03,0x13,0x00,0x03,0x14,0x00,0x03,0x15,0x00,0x03,0x16,0x80,
    0x03,0x18,0x00,0x03,0x19,0x00,0x03,0x1A,0x00,0x03,0x1B,0x80,0x03,0x1C,0x00,
    0x03,0x1D,0x00,0x03,0x1E,0x00,0x03,0x1F,0x00,0x03,0x20,0x00,0x03,0x21,0x80,
    0x03,0x23,0x00,0x03,0x24,0x00,0x03,0x25,0x00,0x03,0x26,0x80,0x03,0x27,0x00,
    0x03,0x28,0x00,0x03,0x29,0x00,0x03,0x2A,0x00,0x03,0x2B,0x00,0x03,0x2C,0x80,
    0x03,0x39,0x00,0x03,0x3B,0x00,0x03,0x3C,0x00,0x03,0x3D,0x00,0x03,0x3E,0x00,
    0x03,0x3F,0x00,0x03,0x40,0x00,0x03,0x41,0x00,0x03,0x42,0x00,0x03,0x43,0x00,
    0x03,0x44,0x00,0x03,0x45,0x00,0x03,0x46,0x00,0x03,0x47,0x00,0x03,0x48,0x00,
    0x03,0x49,0x00,0x03,0x4A,0x00,0x03,0x4B,0x00,0x03,0x4C,0x00,0x03,0x4D,0x00,
    0x03,0x4E,0x00,0x03,0x4F,0x00,0x03,0x50,0x00,0x03,0x51,0x00,0x03,0x52,0x00,
    0x04,0x02,0x01,0x04,0x08,0x10,0x04,0x09,0x22,0x04,0x0A,0x09,0x04,0x0B,0x08, // bank 4
    0x04,0x0C,0x1F,0x04,0x0D,0x3F,0x04,0x0E,0x10,0x04,0x0F,0x24,0x04,0x10,0x09,
    0x04,0x11,0x08,0x04,0x12,0x1F,0x04,0x13,0x3F,0x04,0x15,0x00,0x04,0x16,0x00,
    0x04,0x17,0x00,0x04,0x18,0x00,0x04,0x19,0xB4,0x04,0x1A,0x00,0x04,0x1B,0x00,
    0x04,0x1C,0x00,0x04,0x1D,0x00,0x04,0x1E,0x00,0x04,0x1F,0x80,0x04,0x21,0x31,
    0x04,0x22,0x01,0x04,0x23,0xE3,0x04,0x24,0xA5,0x04,0x25,0x9B,0x04,0x26,0x04,
    0x04,0x27,0x00,0x04,0x28,0x00,0x04,0x29,0x00,0x04,0x2A,0x00,0x04,0x2B,0x01,
    0x04,0x2C,0x0F,0x04,0x2D,0x03,0x04,0x2E,0x15,0x04,0x2F,0x13,0x04,0x31,0x00,
    0x04,0x32,0x42,0x04,0x33,0x03,0x04,0x34,0x00,0x04,0x36,0x0C,0x04,0x37,0x00,
    0x04,0x38,0x01,0x04,0x39,0x00,
    0x05,0x02,0x01,0x05,0x08,0x00,0x05,0x09,0x00,0x05,0x0A,0x00,0x05,0x0B,0x00, // bank 5
    0x05,0x0C,0x00,0x05,0x0D,0x00,0x05,0x0E,0x00,0x05,0x0F,0x00,0x05,0x10,0x00,
    0x05,0x11,0x00,0x05,0x12,0x00,0x05,0x13,0x00,0x05,0x15,0x00,0x05,0x16,0x00,
    0x05,0x17,0x00,0x05,0x18,0x80,0x05,0x19,0x00,0x05,0x1A,0x00,0x05,0x1B,0x00,
    0x05,0x1C,0x00,0x05,0x1D,0x00,0x05,0x1E,0x00,0x05,0x1F,0x80,0x05,0x21,0x21,
    0x05,0x22,0x01,0x05,0x23,0x00,0x05,0x24,0x00,0x05,0x25,0x00,0x05,0x26,0x00,
    0x05,0x27,0x00,0x05,0x28,0x00,0x05,0x29,0x00,0x05,0x2A,0x01,0x05,0x2B,0x01,
    0x05,0x2C,0x0F,0x05,0x2D,0x03,0x05,0x2E,0x00,0x05,0x2F,0x00,0x05,0x31,0x00,
    0x05,0x32,0x00,0x05,0x33,0x04,0x05,0x34,0x00,0x05,0x36,0x0E,0x05,0x37,0x00,
    0x05,0x38,0x00,0x05,0x39,0x00,
    0x06,0x02,0x01,0x06,0x08,0x00,0x06,0x09,0x00,0x06,0x0A,0x00,0x06,0x0B,0x00, // bank 6
    0x06,0x0C,0x00,0x06,0x0D,0x00,0x06,0x0E,0x00,0x06,0x0F,0x00,0x06,0x10,0x00,
    0x06,0x11,0x00,0x06,0x12,0x00,0x06,0x13,0x00,0x06,0x15,0x00,0x06,0x16,0x00,
    0x06,0x17,0x00,0x06,0x18,0x80,0x06,0x19,0x00,0x06,0x1A,0x00,0x06,0x1B,0x00,
    0x06,0x1C,0x00,0x06,0x1D,0x00,0x06,0x1E,0x00,0x06,0x1F,0x80,0x06,0x21,0x21,
    0x06,0x22,0x01,0x06,0x23,0x00,0x06,0x24,0x00,0x06,0x25,0x00,0x06,0x26,0x00,
    0x06,0x27,0x00,0x06,0x28,0x00,0x06,0x29,0x00,0x06,0x2A,0x00,0x06,0x2B,0x01,
    0x06,0x2C,0x0F,0x06,0x2D,0x03,0x06,0x2E,0x00,0x06,0x2F,0x00,0x06,0x31,0x00,
    0x06,0x32,0x00,0x06,0x33,0x04,0x06,0x34,0x00,0x06,0x36,0x0E,0x06,0x37,0x00,
    0x06,0x38,0x00,0x06,0x39,0x00,
    0x07,0x02,0x01,0x07,0x09,0x00,0x07,0x0A,0x00,0x07,0x0B,0x00,0x07,0x0C,0x00, // bank 7
    0x07,0x0D,0x00,0x07,0x0E,0x00,0x07,0x0F,0x00,0x07,0x10,0x00,0x07,0x11,0x00,
    0x07,0x12,0x00,0x07,0x13,0x00,0x07,0x14,0x00,0x07,0x16,0x00,0x07,0x17,0x00,
    0x07,0x18,0x00,0x07,0x19,0x80,0x07,0x1A,0x00,0x07,0x1B,0x00,0x07,0x1C,0x00,
    0x07,0x1D,0x00,0x07,0x1E,0x00,0x07,0x1F,0x00,0x07,0x20,0x80,0x07,0x22,0x21,
    0x07,0x23,0x01,0x07,0x24,0x00,0x07,0x25,0x00,0x07,0x26,0x00,0x07,0x27,0x00,
    0x07,0x28,0x00,0x07,0x29,0x00,0x07,0x2A,0x00,0x07,0x2B,0x00,0x07,0x2C,0x01,
    0x07,0x2D,0x0F,0x07,0x2E,0x03,0x07,0x2F,0x00,0x07,0x30,0x00,0x07,0x32,0x00,
    0x07,0x33,0x00,0x07,0x34,0x04,0x07,0x35,0x00,0x07,0x37,0x0E,0x07,0x38,0x00,
    0x07,0x39,0x00,0x07,0x3A,0x00,
    0x09,0x0E,0x02,0x09,0x43,0x00,0x09,0x49,0x01,0x09,0x4A,0x01,                // bank 9
    0x0A,0x03,0x01,0x0A,0x04,0x00,0x0A,0x05,0x01,                               // bank A
    0x0B,0x44,0xEF,0x0B,0x45,0x0E,0x0B,0x46,0x00,0x0B,0x47,0x00,0x0B,0x48,0x0E,
    0x0B,0x4A,0x0E,                                                             // bank B
    0x04,0x14,0x01,                                                             // bank 4
    0x00,0x1C,0x01};                                                             // bank 0
//    0x0B,0x24,0xC0,0x0B,0x25,0x02};                                             // bank B                                    // bank B

#define COMMENT_RESET "Reset"
void reset_wrong(int file);
void reset(int file);
void writeRegs(int file, char* bufdata, int size, const char* comment);
void initJC(int file);
int IsJitterCleanerReady(int file);

int main () {
  int file_i2c;

  fprintf(stderr, "Initialization of I2C for jitter cleaner ..... ");
  file_i2c = open(I2C_DEVICE_NAME, O_RDWR);
  if (file_i2c < 0) {
    fprintf(stderr, "Error 1\n");
    exit(1); }

  if (ioctl(file_i2c, I2C_SLAVE, IIC_SLAVE_SI5347) < 0) {
    fprintf(stderr, "Error 2\n");
    exit(1); }
  fprintf(stderr, "OK\n");

#ifdef TESTDUMP
  printf("Register dump before init:\n");
  dump(file_i2c);
#endif

  initJC(file_i2c);

#ifdef TESTDUMP
  printf("Register dump after init:\n");
  dump(file_i2c);
  
  printf("Register dump after reset_wrong:\n");
  reset_wrong(file_i2c);
  dump(file_i2c);
  
  printf("Register dump after reset:\n");
  reset(file_i2c);
  dump(file_i2c);
#endif
  
  close(file_i2c);
  return 0;
}


//********************************************
//*    Is Jitter Cleaner Ready ?
int IsJitterCleanerReady(int file) {
  int k;
  char reg[] ={0xFE}; // JC register ready

  for(k = 0; k < 1000; k++){
    if(write(file, reg, 1) < 1) {
       fprintf(stderr, "Error 6\n");
       exit(1); }
     if(read(file, reg, 1) != 1) {
       fprintf(stderr, "Error 7\n");
       exit(1); }
     if(reg[0] == 0x0F)
       return 1;
   }
   return 0;
}


//////////////////////////////////////////////////////
void dump (int file) {
  int i, j, k, length;
  static char RecvBuffer[256];
  char reg[2];

  for (i = 0; i<256; i++) { RecvBuffer[i] = 0;} // set the receiver buffer to 0

  for (j = 0x0; j < 0xc; j++)  // read the internal register bank by bank
    {
      reg[0] = 1;
      reg[1] = j;
      length = 2;
      if (write(file, reg, length) != length) {
	fprintf(stderr, "Error 8\n");
	exit(1); }
      usleep (50000);
      reg[0] = 0;
      length = 2;
      if (write(file, reg, length) != length) {
	fprintf(stderr, "Error 9\n");
	exit(1); }
      usleep (50000);

      printf("#################################################\n\n");
      printf("Bank number: %x \n",j);

      length = 256;
      if (read(file,RecvBuffer,length)!= length) {
	fprintf(stderr, "Error 10\n");
	exit(1); }
	
      for (i = 0; i<255; i=i+16) {
	for (k=0; k<16;k++)
	  fprintf(stderr, " %2x", RecvBuffer[i+k]);
	printf(" \r\n"); }
    }
  printf("-------------------------------------------------\n\n");
}

void writeRegs(int file, char* bufdata, int size, const char* comment) {
  int k;
  unsigned char i2buf[2];
  
  // registers config
  for ( k = 0; k < size; k=k+3) {
    i2buf[0] = 0x01;
    i2buf[1] = bufdata[k];
    if(write(file, i2buf, 2) < 2) {
      fprintf(stderr, "Error page set %s @%d\n", comment, k);
      exit(1); }
    /* after Hard reset, no ACK on I2C =>
       write returns -1 with errno=6 'No such device or address' */
    if( write(file, bufdata + k+1, 2) < 2 &&
	strcmp(comment, COMMENT_RESET) != 0 ) {
      fprintf(stderr, "Error register write %s @%d\n", comment, k);
      exit(1); }
  }
}

void initJC(int file) {
  fprintf(stderr, "Initialization of Jitter cleaner .... ");
  reset(file);
  usleep (300000); // delay 300ms after hard reset
  writeRegs(file, bufEric, sizeof(bufEric), "Preamble");
  usleep (300000); // delay 300ms 
  writeRegs(file, buf, sizeof(buf), "All registers");
  fprintf(stderr, "OK\n");
}
  
/* this reset does not work */
void reset_wrong(int file) {
  if(write(file, setHardReset, sizeof(setHardReset)) < sizeof(setHardReset)) {
    fprintf(stderr, "Error 4\n");
    exit(1); }
}

void reset(int file) {
  if(IsJitterCleanerReady(file) == 0) {
    fprintf(stderr, "Error 5\n");
    exit(1); }
  writeRegs(file, bufHardReset, sizeof(bufHardReset), COMMENT_RESET);
}
